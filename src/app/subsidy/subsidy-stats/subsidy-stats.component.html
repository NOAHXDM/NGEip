<div class="container-fluid mt-4">
  <mat-card appearance="outlined">
    <mat-card-header class="d-flex justify-content-between align-items-center">
      <h2 class="mb-0">Subsidy Statistics</h2>

      <!-- 年度選擇器 -->
      <mat-form-field appearance="outline" style="width: 150px;">
        <mat-label>Year</mat-label>
        <mat-select [value]="selectedYear()" (selectionChange)="onYearChange($event.value)">
          @for (year of yearOptions; track year) {
            <mat-option [value]="year">{{ year }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </mat-card-header>

    <mat-card-content>
      <!-- Tab 切換：個人統計 / 系統統計 -->
      <mat-tab-group>
        <!-- 個人統計 -->
        <mat-tab label="My Statistics">
          @if (userStats$ | async; as stats) {
            <div class="mt-3">
              <!-- 總覽卡片 -->
              <div class="row g-3 mb-4">
                <div class="col-md-3">
                  <mat-card appearance="outlined" class="text-center">
                    <mat-card-content>
                      <mat-icon style="font-size: 48px; width: 48px; height: 48px;" color="primary">account_balance_wallet</mat-icon>
                      <h3 class="mb-0 mt-2">{{ stats.grandTotal | currency:'TWD':'symbol':'1.0-0' }}</h3>
                      <p class="text-muted mb-0">Total Subsidy</p>
                    </mat-card-content>
                  </mat-card>
                </div>
                <div class="col-md-3">
                  <mat-card appearance="outlined" class="text-center">
                    <mat-card-content>
                      <mat-icon style="font-size: 48px; width: 48px; height: 48px;" color="primary">receipt</mat-icon>
                      <h3 class="mb-0 mt-2">{{ stats.totalSubsidyAmount | currency:'TWD':'symbol':'1.0-0' }}</h3>
                      <p class="text-muted mb-0">Application Subsidy</p>
                    </mat-card-content>
                  </mat-card>
                </div>
                <div class="col-md-3">
                  <mat-card appearance="outlined" class="text-center">
                    <mat-card-content>
                      <mat-icon style="font-size: 48px; width: 48px; height: 48px;" color="primary">restaurant</mat-icon>
                      <h3 class="mb-0 mt-2">{{ stats.totalMealAmount | currency:'TWD':'symbol':'1.0-0' }}</h3>
                      <p class="text-muted mb-0">Meal Subsidy</p>
                    </mat-card-content>
                  </mat-card>
                </div>
                <div class="col-md-3">
                  <mat-card appearance="outlined" class="text-center">
                    <mat-card-content>
                      <mat-icon style="font-size: 48px; width: 48px; height: 48px;" color="primary">fastfood</mat-icon>
                      <h3 class="mb-0 mt-2">{{ stats.totalMealCount }}</h3>
                      <p class="text-muted mb-0">Meal Count</p>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>

              <!-- 依類型統計 -->
              <h4>Subsidy by Type</h4>
              <div class="table-container mat-elevation-z2 mb-4">
                <table mat-table [dataSource]="stats.subsidyByType" class="w-100">
                  <ng-container matColumnDef="type">
                    <th mat-header-cell *matHeaderCellDef>Type</th>
                    <td mat-cell *matCellDef="let element">{{ element.type | subsidyType }}</td>
                  </ng-container>

                  <ng-container matColumnDef="count">
                    <th mat-header-cell *matHeaderCellDef>Count</th>
                    <td mat-cell *matCellDef="let element">{{ element.count }}</td>
                  </ng-container>

                  <ng-container matColumnDef="totalAmount">
                    <th mat-header-cell *matHeaderCellDef>Total Amount</th>
                    <td mat-cell *matCellDef="let element">{{ element.totalAmount | currency:'TWD':'symbol':'1.0-0' }}</td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="['type', 'count', 'totalAmount']"></tr>
                  <tr mat-row *matRowDef="let row; columns: ['type', 'count', 'totalAmount']"></tr>
                </table>
              </div>

              <!-- 月度餐費統計 -->
              @if (stats.mealByMonth.length > 0) {
                <h4>Meal Subsidy by Month</h4>
                <div class="table-container mat-elevation-z2">
                  <table mat-table [dataSource]="stats.mealByMonth" class="w-100">
                    <ng-container matColumnDef="yearMonth">
                      <th mat-header-cell *matHeaderCellDef>Month</th>
                      <td mat-cell *matCellDef="let element">{{ element.yearMonth }}</td>
                    </ng-container>

                    <ng-container matColumnDef="mealCount">
                      <th mat-header-cell *matHeaderCellDef>Meal Count</th>
                      <td mat-cell *matCellDef="let element">{{ element.mealCount }}</td>
                    </ng-container>

                    <ng-container matColumnDef="totalAmount">
                      <th mat-header-cell *matHeaderCellDef>Total Amount</th>
                      <td mat-cell *matCellDef="let element">{{ element.totalAmount | currency:'TWD':'symbol':'1.0-0' }}</td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="['yearMonth', 'mealCount', 'totalAmount']"></tr>
                    <tr mat-row *matRowDef="let row; columns: ['yearMonth', 'mealCount', 'totalAmount']"></tr>
                  </table>
                </div>
              }
            </div>
          } @else {
            <div class="mt-3 text-center text-muted">
              <p>No statistics available</p>
            </div>
          }
        </mat-tab>

        <!-- 系統統計 -->
        <mat-tab label="System Statistics">
            <div class="mt-3">
              <!-- 補助統計 -->
              <h4>Subsidy Statistics</h4>
              @if (systemSubsidyStats$ | async; as stats) {
                <!-- 總覽卡片 -->
                <div class="row g-3 mb-4">
                  <div class="col-md-4">
                    <mat-card appearance="outlined" class="text-center">
                      <mat-card-content>
                        <mat-icon style="font-size: 48px; width: 48px; height: 48px;" color="primary">paid</mat-icon>
                        <h3 class="mb-0 mt-2">{{ stats.totalAmount | currency:'TWD':'symbol':'1.0-0' }}</h3>
                        <p class="text-muted mb-0">Total Subsidy Amount</p>
                      </mat-card-content>
                    </mat-card>
                  </div>
                  <div class="col-md-4">
                    <mat-card appearance="outlined" class="text-center">
                      <mat-card-content>
                        <mat-icon style="font-size: 48px; width: 48px; height: 48px;" color="primary">folder_open</mat-icon>
                        <h3 class="mb-0 mt-2">{{ stats.totalCount }}</h3>
                        <p class="text-muted mb-0">Total Applications</p>
                      </mat-card-content>
                    </mat-card>
                  </div>
                  <div class="col-md-4">
                    <mat-card appearance="outlined" class="text-center">
                      <mat-card-content>
                        <mat-icon style="font-size: 48px; width: 48px; height: 48px;" color="primary">people</mat-icon>
                        <h3 class="mb-0 mt-2">{{ stats.totalUsers }}</h3>
                        <p class="text-muted mb-0">Total Users</p>
                      </mat-card-content>
                    </mat-card>
                  </div>
                </div>

                <!-- 依類型統計 -->
                <div class="table-container mat-elevation-z2 mb-4">
                  <table mat-table [dataSource]="stats.byType" class="w-100">
                    <ng-container matColumnDef="type">
                      <th mat-header-cell *matHeaderCellDef>Type</th>
                      <td mat-cell *matCellDef="let element">{{ element.type | subsidyType }}</td>
                    </ng-container>

                    <ng-container matColumnDef="count">
                      <th mat-header-cell *matHeaderCellDef>Count</th>
                      <td mat-cell *matCellDef="let element">{{ element.count }}</td>
                    </ng-container>

                    <ng-container matColumnDef="totalAmount">
                      <th mat-header-cell *matHeaderCellDef>Total Amount</th>
                      <td mat-cell *matCellDef="let element">{{ element.totalAmount | currency:'TWD':'symbol':'1.0-0' }}</td>
                    </ng-container>

                    <ng-container matColumnDef="userCount">
                      <th mat-header-cell *matHeaderCellDef>User Count</th>
                      <td mat-cell *matCellDef="let element">{{ element.userCount }}</td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="subsidyTypeColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: subsidyTypeColumns"></tr>
                  </table>
                </div>
              }

              <!-- 餐費統計 -->
              <h4>Meal Subsidy Statistics</h4>
              @if (systemMealStats$ | async; as stats) {
                <!-- 總覽 -->
                <div class="row g-3 mb-4">
                  <div class="col-md-6">
                    <mat-card appearance="outlined" class="text-center">
                      <mat-card-content>
                        <mat-icon style="font-size: 48px; width: 48px; height: 48px;" color="primary">restaurant_menu</mat-icon>
                        <h3 class="mb-0 mt-2">{{ calculateMealYearTotal(stats) | currency:'TWD':'symbol':'1.0-0' }}</h3>
                        <p class="text-muted mb-0">Total Meal Amount</p>
                      </mat-card-content>
                    </mat-card>
                  </div>
                  <div class="col-md-6">
                    <mat-card appearance="outlined" class="text-center">
                      <mat-card-content>
                        <mat-icon style="font-size: 48px; width: 48px; height: 48px;" color="primary">analytics</mat-icon>
                        <h3 class="mb-0 mt-2">{{ calculateMealYearAverage(stats) | currency:'TWD':'symbol':'1.0-0' }}</h3>
                        <p class="text-muted mb-0">Average Per User (Monthly)</p>
                      </mat-card-content>
                    </mat-card>
                  </div>
                </div>

                <!-- 月度統計 -->
                <div class="table-container mat-elevation-z2">
                  <table mat-table [dataSource]="stats" class="w-100">
                    <ng-container matColumnDef="yearMonth">
                      <th mat-header-cell *matHeaderCellDef>Month</th>
                      <td mat-cell *matCellDef="let element">{{ element.yearMonth }}</td>
                    </ng-container>

                    <ng-container matColumnDef="userCount">
                      <th mat-header-cell *matHeaderCellDef>User Count</th>
                      <td mat-cell *matCellDef="let element">{{ element.userCount }}</td>
                    </ng-container>

                    <ng-container matColumnDef="totalMealCount">
                      <th mat-header-cell *matHeaderCellDef>Total Meal Count</th>
                      <td mat-cell *matCellDef="let element">{{ element.totalMealCount }}</td>
                    </ng-container>

                    <ng-container matColumnDef="totalAmount">
                      <th mat-header-cell *matHeaderCellDef>Total Amount</th>
                      <td mat-cell *matCellDef="let element">{{ element.totalAmount | currency:'TWD':'symbol':'1.0-0' }}</td>
                    </ng-container>

                    <ng-container matColumnDef="averagePerUser">
                      <th mat-header-cell *matHeaderCellDef>Average Per User</th>
                      <td mat-cell *matCellDef="let element">{{ element.averagePerUser | currency:'TWD':'symbol':'1.0-0' }}</td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="mealMonthColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: mealMonthColumns"></tr>
                  </table>
                </div>
              }

            </div>
          </mat-tab>
      </mat-tab-group>
    </mat-card-content>

    <mat-card-footer class="ranking-footer">
      <div class="footer-title">
        <mat-icon>leaderboard</mat-icon>
        <span>View Complete Rankings</span>
      </div>
      <div class="ranking-buttons">
        <button mat-stroked-button color="primary" (click)="openRankingDialog('laptop')">
          <mat-icon>laptop</mat-icon>
          Laptop Subsidy
        </button>
        <button mat-stroked-button color="primary" (click)="openRankingDialog('healthCheck')">
          <mat-icon>health_and_safety</mat-icon>
          Health Check
        </button>
        <button mat-stroked-button color="primary" (click)="openRankingDialog('training')">
          <mat-icon>school</mat-icon>
          Training Course
        </button>
        <button mat-stroked-button color="primary" (click)="openRankingDialog('aiTool')">
          <mat-icon>smart_toy</mat-icon>
          AI Tool
        </button>
        <button mat-stroked-button color="primary" (click)="openRankingDialog('travel')">
          <mat-icon>flight</mat-icon>
          Travel Subsidy
        </button>
        <button mat-stroked-button color="primary" (click)="openRankingDialog('meal')">
          <mat-icon>restaurant</mat-icon>
          Meal Subsidy
        </button>
      </div>
    </mat-card-footer>
  </mat-card>
</div>
