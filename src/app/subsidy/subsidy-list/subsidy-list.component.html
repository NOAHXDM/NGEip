<div class="container-fluid mt-4">
  <mat-card appearance="outlined">
    <mat-card-header class="d-flex flex-wrap justify-content-between align-items-center">
      <!-- 新增申請按鈕 -->
      <button type="button" mat-mini-fab color="primary" (click)="openNewApplicationDialog()">
        <mat-icon>add</mat-icon>
      </button>

      <!-- 類型過濾器 -->
      <mat-form-field appearance="outline" style="min-width: 200px;">
        <mat-label>Subsidy Type</mat-label>
        <mat-select [(value)]="selectedType" (selectionChange)="onTypeFilterChange($event.value)">
          <mat-option [value]="null">All Types</mat-option>
          @for (type of typeList; track type.value) {
            <mat-option [value]="type.value">{{ type.text }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- 日期範圍過濾器 -->
      <form [formGroup]="dateRangeForm" class="d-flex gap-2 align-items-center">
        <mat-form-field appearance="outline" style="width: 150px;">
          <mat-label>Start Date</mat-label>
          <input matInput [matDatepicker]="startPicker" formControlName="start" (dateChange)="onDateRangeChange()">
          <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" style="width: 150px;">
          <mat-label>End Date</mat-label>
          <input matInput [matDatepicker]="endPicker" formControlName="end" (dateChange)="onDateRangeChange()">
          <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>

        <button type="button" mat-icon-button (click)="dateRangeForm.reset(); loadAllApplications()" title="Clear filters">
          <mat-icon>clear</mat-icon>
        </button>
      </form>
    </mat-card-header>

    <mat-card-content class="pt-2">

      <!-- Tab 切換 -->
      <mat-tab-group (selectedIndexChange)="onTabChange($event)" [selectedIndex]="selectedTabIndex">
        <!-- 全部申請 -->
        <mat-tab label="All Applications">
          @if (allApplicationsList$ | async; as dataSource) {
            <div class="table-container mat-elevation-z2">
              <table mat-table [dataSource]="dataSource" matSort class="w-100">
                <!-- 狀態 -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let element">
                    @switch (element.status) {
                      @case ('pending') {
                        <mat-icon title="Pending">pending_actions</mat-icon>
                      }
                      @case ('approved') {
                        <mat-icon style="color: green" title="Approved">check_circle</mat-icon>
                      }
                      @case ('rejected') {
                        <mat-icon color="warn" title="Rejected">cancel</mat-icon>
                      }
                    }
                  </td>
                </ng-container>

                <!-- 類型 -->
                <ng-container matColumnDef="type">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
                  <td mat-cell *matCellDef="let element">{{ element.type | subsidyType }}</td>
                </ng-container>

                <!-- 申請人 -->
                <ng-container matColumnDef="userId">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Applicant</th>
                  <td mat-cell *matCellDef="let element">{{ element.userId | userName }}</td>
                </ng-container>

                <!-- 申請日期 -->
                <ng-container matColumnDef="applicationDate">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Application Date</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.applicationDate | firestoreTimestamp : 'yyyy-MM-dd' }}
                  </td>
                </ng-container>

                <!-- 內容 -->
                <ng-container matColumnDef="content">
                  <th mat-header-cell *matHeaderCellDef>Content</th>
                  <td mat-cell *matCellDef="let element">{{ element.content || '-' }}</td>
                </ng-container>

                <!-- 發票金額 -->
                <ng-container matColumnDef="invoiceAmount">
                  <th mat-header-cell *matHeaderCellDef>Invoice Amount</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.invoiceAmount ? '$' + element.invoiceAmount : '-' }}
                  </td>
                </ng-container>

                <!-- 核准金額 -->
                <ng-container matColumnDef="approvedAmount">
                  <th mat-header-cell *matHeaderCellDef>Approved Amount</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.approvedAmount ? '$' + element.approvedAmount : '-' }}
                  </td>
                </ng-container>

                <!-- 操作 -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Actions</th>
                  <td mat-cell *matCellDef="let element">
                    <button mat-icon-button [matMenuTriggerFor]="allActionMenu">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #allActionMenu="matMenu">
                      <button mat-menu-item (click)="openHistoryDialog(element)">
                        <mat-icon>history</mat-icon>
                        <span>View History</span>
                      </button>
                      @if (element.type === 1 && element.status === 'approved') {
                        <button mat-menu-item (click)="openInstallmentDialog(element)">
                          <mat-icon>payments</mat-icon>
                          <span>Installment Records</span>
                        </button>
                      }
                      @if ((isAdmin$ | async) && element.status === 'pending') {
                        <button mat-menu-item (click)="openEditApplicationDialog(element)">
                          <mat-icon>edit</mat-icon>
                          <span>Edit</span>
                        </button>
                        <button mat-menu-item (click)="openStatusChangeDialog(element, 'approved')">
                          <mat-icon style="color: green">check_circle</mat-icon>
                          <span>Approve</span>
                        </button>
                        <button mat-menu-item (click)="openStatusChangeDialog(element, 'rejected')">
                          <mat-icon color="warn">cancel</mat-icon>
                          <span>Reject</span>
                        </button>
                      }
                    </mat-menu>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>
            </div>
          }
        </mat-tab>

        <!-- 我的申請 -->
        <mat-tab label="My Applications">
          @if (myApplicationsList$ | async; as dataSource) {
            <div class="table-container mat-elevation-z2">
              <table mat-table [dataSource]="dataSource" matSort class="w-100">
                <!-- 狀態 -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let element">
                    @switch (element.status) {
                      @case ('pending') {
                        <mat-icon  title="Pending">pending_actions</mat-icon>
                      }
                      @case ('approved') {
                        <mat-icon style="color: green" title="Approved">check_circle</mat-icon>
                      }
                      @case ('rejected') {
                        <mat-icon color="warn" title="Rejected">cancel</mat-icon>
                      }
                    }
                  </td>
                </ng-container>

                <!-- 類型 -->
                <ng-container matColumnDef="type">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
                  <td mat-cell *matCellDef="let element">{{ element.type | subsidyType }}</td>
                </ng-container>

                <!-- 申請人 -->
                <ng-container matColumnDef="userId">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Applicant</th>
                  <td mat-cell *matCellDef="let element">{{ element.userId | userName }}</td>
                </ng-container>

                <!-- 申請日期 -->
                <ng-container matColumnDef="applicationDate">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Application Date</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.applicationDate | firestoreTimestamp : 'yyyy-MM-dd' }}
                  </td>
                </ng-container>

                <!-- 內容 -->
                <ng-container matColumnDef="content">
                  <th mat-header-cell *matHeaderCellDef>Content</th>
                  <td mat-cell *matCellDef="let element">{{ element.content || '-' }}</td>
                </ng-container>

                <!-- 發票金額 -->
                <ng-container matColumnDef="invoiceAmount">
                  <th mat-header-cell *matHeaderCellDef>Invoice Amount</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.invoiceAmount ? '$' + element.invoiceAmount : '-' }}
                  </td>
                </ng-container>

                <!-- 核准金額 -->
                <ng-container matColumnDef="approvedAmount">
                  <th mat-header-cell *matHeaderCellDef>Approved Amount</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.approvedAmount ? '$' + element.approvedAmount : '-' }}
                  </td>
                </ng-container>

                <!-- 操作 -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Actions</th>
                  <td mat-cell *matCellDef="let element">
                    <button mat-icon-button [matMenuTriggerFor]="actionMenu">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #actionMenu="matMenu">
                      <button mat-menu-item (click)="openHistoryDialog(element)">
                        <mat-icon>history</mat-icon>
                        <span>View History</span>
                      </button>
                      @if (element.status === 'pending') {
                        <button mat-menu-item (click)="openEditApplicationDialog(element)">
                          <mat-icon>edit</mat-icon>
                          <span>Edit</span>
                        </button>
                      }
                      @if (element.type === 1 && element.status === 'approved') {
                        <button mat-menu-item (click)="openInstallmentDialog(element)">
                          <mat-icon>payments</mat-icon>
                          <span>Installment Records</span>
                        </button>
                      }
                    </mat-menu>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>
            </div>
          }
        </mat-tab>

        <!-- 待審核（僅管理員可見） -->
        @if (isAdmin$ | async) {
          <mat-tab label="Pending Review">
            @if (pendingApplicationsList$ | async; as dataSource) {
              <div class="table-container mat-elevation-z2">
                <table mat-table [dataSource]="dataSource" matSort class="w-100">
                  <!-- 重用相同的欄位定義 -->
                  <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Status</th>
                    <td mat-cell *matCellDef="let element">
                      <mat-icon title="Pending">pending_actions</mat-icon>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="type">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
                    <td mat-cell *matCellDef="let element">{{ element.type | subsidyType }}</td>
                  </ng-container>

                  <ng-container matColumnDef="userId">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Applicant</th>
                    <td mat-cell *matCellDef="let element">{{ element.userId | userName }}</td>
                  </ng-container>

                  <ng-container matColumnDef="applicationDate">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Application Date</th>
                    <td mat-cell *matCellDef="let element">
                      {{ element.applicationDate | firestoreTimestamp : 'yyyy-MM-dd' }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="content">
                    <th mat-header-cell *matHeaderCellDef>Content</th>
                    <td mat-cell *matCellDef="let element">{{ element.content || '-' }}</td>
                  </ng-container>

                  <ng-container matColumnDef="invoiceAmount">
                    <th mat-header-cell *matHeaderCellDef>Invoice Amount</th>
                    <td mat-cell *matCellDef="let element">
                      {{ element.invoiceAmount ? '$' + element.invoiceAmount : '-' }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="approvedAmount">
                    <th mat-header-cell *matHeaderCellDef>Approved Amount</th>
                    <td mat-cell *matCellDef="let element">
                      {{ element.approvedAmount ? '$' + element.approvedAmount : '-' }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                    <td mat-cell *matCellDef="let element">
                      <button mat-icon-button [matMenuTriggerFor]="adminActionMenu">
                        <mat-icon>more_vert</mat-icon>
                      </button>
                      <mat-menu #adminActionMenu="matMenu">
                        <button mat-menu-item (click)="openEditApplicationDialog(element)">
                          <mat-icon>edit</mat-icon>
                          <span>Edit</span>
                        </button>
                        <button mat-menu-item (click)="openStatusChangeDialog(element, 'approved')">
                          <mat-icon style="color: green">check_circle</mat-icon>
                          <span>Approve</span>
                        </button>
                        <button mat-menu-item (click)="openStatusChangeDialog(element, 'rejected')">
                          <mat-icon color="warn">cancel</mat-icon>
                          <span>Reject</span>
                        </button>
                        <button mat-menu-item (click)="openHistoryDialog(element)">
                          <mat-icon>history</mat-icon>
                          <span>View History</span>
                        </button>
                      </mat-menu>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                </table>
              </div>
            }
          </mat-tab>
        }
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</div>
