<div class="container d-flex justify-content-center align-items-center py-2">
  <mat-tab-group dynamicHeight>
    <mat-tab label="Normal">
      <ng-container *ngTemplateOutlet="normalContent"></ng-container>
    </mat-tab>
    <mat-tab label="Advanced" *ngIf="isAdmin$ | async">
      <ng-container *ngTemplateOutlet="advancedContent"></ng-container>
    </mat-tab>
    <mat-tab label="Remaining Leave Hours">
      <ng-container
        *ngTemplateOutlet="remainingLeaveHoursContent"
      ></ng-container>
    </mat-tab>
    <mat-tab label="Subsidy Limit">
      <ng-container *ngTemplateOutlet="subsidyLimitContent"></ng-container>
    </mat-tab>
  </mat-tab-group>
</div>

<ng-template #normalContent>
  <form
    class="d-flex flex-column gap-3"
    [formGroup]="profileForm"
    (ngSubmit)="normalFieldsUpdate()"
    novalidate
  >
    <!-- Photo -->
    <div class="avatar-layout">
      <div class="avatar-circle" (click)="openWidget()">
        @if (profileForm.get("photoUrl")?.value) {
        <img [src]="profileForm.get('photoUrl')?.value" class="avatar-circle" />
        }@else {
        <div>
          {{ profileForm.get("name")?.value?.at(0) }}
        </div>
        }
      </div>
    </div>
    <h3 class="pt-3 text-center">{{ title }}</h3>

    <!-- Name -->
    <mat-form-field appearance="outline">
      <mat-label>Name</mat-label>
      <input type="text" matInput formControlName="name" />
      <mat-icon matSuffix>title</mat-icon>
      <mat-hint>Enter you name</mat-hint>
    </mat-form-field>
    <!-- Phone -->
    <mat-form-field appearance="outline">
      <mat-label>Phone</mat-label>
      <input type="text" matInput formControlName="phone" />
      <mat-icon matSuffix>call</mat-icon>
      <mat-hint>Enter you phone</mat-hint>
    </mat-form-field>

    <!-- Remote Work Eligibility -->
    <mat-form-field appearance="outline">
      <mat-label>Remote Work Eligibility</mat-label>
      <mat-select formControlName="remoteWorkEligibility">
        @for (value of remoteWorkEligibilityOptions; track value) {
        <mat-option [value]="value">{{ value }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
    <!-- Remote Work Recommender -->
    <mat-form-field appearance="outline">
      <mat-label>Remote Work Recommender</mat-label>
      <mat-select formControlName="remoteWorkRecommender" multiple>
        @for (user of userList$ | async; track user.uid) {
        <mat-option [value]="user.uid">{{ user.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
    <!-- Birthday -->
    <mat-form-field appearance="outline">
      <mat-label>Birthday</mat-label>
      <mtx-datetimepicker
        #birthdayPicker
        type="date"
        mode="auto"
        multiYearSelector="month"
      >
      </mtx-datetimepicker>
      <input
        [mtxDatetimepicker]="birthdayPicker"
        formControlName="birthday"
        matInput
      />
      <mtx-datetimepicker-toggle
        [for]="birthdayPicker"
        matSuffix
      ></mtx-datetimepicker-toggle>
    </mat-form-field>
    <button type="submit" mat-flat-button [disabled]="profileForm.invalid">
      Update
    </button>
  </form>
</ng-template>

<ng-template #advancedContent>
  <form
    class="d-flex flex-column gap-3"
    [formGroup]="advancedForm"
    (ngSubmit)="advancedFieldsUpdate()"
    novalidate
  >
    <h3 class="pt-3 text-center">{{ title }}</h3>
    <!-- Job Title -->
    <mat-form-field appearance="outline">
      <mat-label>Job Title</mat-label>
      <input type="text" matInput formControlName="jobTitle" />
      <mat-icon matSuffix>badge</mat-icon>
      <mat-hint>Enter you job title</mat-hint>
    </mat-form-field>
    <!-- Job Rank -->
    <mat-form-field appearance="outline">
      <mat-label>Job Rank</mat-label>
      <input type="text" matInput formControlName="jobRank" />
      <mat-icon matSuffix>military_tech</mat-icon>
      <mat-hint>Enter you job rank</mat-hint>
    </mat-form-field>
    <!-- Role -->
    <mat-form-field appearance="outline">
      <mat-label>Role</mat-label>
      <mat-select formControlName="role">
        @for (role of roleOptions; track role) {
        <mat-option [value]="role">{{ role }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
    <!-- Start Date -->
    <mat-form-field appearance="outline">
      <mat-label>Start Date</mat-label>
      <mtx-datetimepicker
        #startDatePicker
        type="date"
        mode="auto"
        multiYearSelector="month"
      >
      </mtx-datetimepicker>
      <input
        [mtxDatetimepicker]="startDatePicker"
        formControlName="startDate"
        matInput
      />
      <mtx-datetimepicker-toggle
        [for]="startDatePicker"
        matSuffix
      ></mtx-datetimepicker-toggle>
    </mat-form-field>
    <!-- Exit Date -->
    <mat-form-field appearance="outline">
      <mat-label>Exit Date</mat-label>
      <mtx-datetimepicker
        #exitDatePicker
        type="date"
        mode="auto"
        multiYearSelector="month"
      >
      </mtx-datetimepicker>
      <input
        [mtxDatetimepicker]="exitDatePicker"
        formControlName="exitDate"
        matInput
      />
      <mtx-datetimepicker-toggle
        [for]="exitDatePicker"
        matSuffix
      ></mtx-datetimepicker-toggle>
    </mat-form-field>

    <button type="submit" mat-flat-button [disabled]="advancedForm.invalid">
      Update
    </button>
  </form>
</ng-template>

<ng-template #remainingLeaveHoursContent>
  <div class="d-flex flex-column gap-3">
    <button type="button" mat-button disabled>
      <mat-icon>local_cafe</mat-icon>
      Remaining {{ remainingLeaveHours() }} hours
    </button>

    @if(isAdmin$ | async) {
    <button type="button" mat-fab extended (click)="settlement()">
      <mat-icon>favorite</mat-icon>
      Settlement
    </button>
    }

    <section class="table-container mat-elevation-z8">
      <mat-table [dataSource]="(leaveTransactionHistory$ | async)!">
        <!-- Date -->
        <ng-container matColumnDef="date">
          <mat-header-cell *matHeaderCellDef>Date</mat-header-cell>
          <mat-cell *matCellDef="let element">{{
            element.date | firestoreTimestamp
          }}</mat-cell>
        </ng-container>
        <!-- Hours -->
        <ng-container matColumnDef="hours">
          <mat-header-cell *matHeaderCellDef>Hours</mat-header-cell>
          <mat-cell *matCellDef="let element">{{ element.hours }}</mat-cell>
        </ng-container>
        <!-- Reason -->
        <ng-container matColumnDef="reason">
          <mat-header-cell *matHeaderCellDef>Reason</mat-header-cell>
          <mat-cell *matCellDef="let element">{{ element.reason }}</mat-cell>
        </ng-container>
        <!-- Action by -->
        <ng-container matColumnDef="actionBy">
          <mat-header-cell *matHeaderCellDef>Action by</mat-header-cell>
          <mat-cell *matCellDef="let element">{{
            element.actionBy | userName
          }}</mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns"></mat-row>
      </mat-table>
    </section>

    @if(isAdmin$ | async) {
    <form
      class="d-flex flex-column gap-3"
      [formGroup]="remainingLeaveHoursForm"
      (ngSubmit)="leaveTransaction()"
      novalidate
    >
      <h6 class="text-center">Add/Deduct</h6>
      <!-- HOURS -->
      <mat-form-field appearance="outline">
        <mat-label>Hours</mat-label>
        <input matInput type="number" step="0.5" formControlName="hours" />
      </mat-form-field>
      <!-- REASON -->
      <mat-form-field appearance="outline">
        <mat-label>Reason</mat-label>
        <textarea matInput formControlName="reason"></textarea>
      </mat-form-field>
      <button
        type="submit"
        mat-flat-button
        [disabled]="remainingLeaveHoursForm.invalid"
      >
        Submit
      </button>
    </form>
    }
  </div>
</ng-template>

<ng-template #confirmationDialog let-data>
  <h2 mat-dialog-title>Full {{ data.yearCompleted }} years</h2>
  <mat-dialog-content class="mat-typography">
    <p>Add hours: {{ data.leaveDays * 8 }}</p>
  </mat-dialog-content>
  <mat-dialog-actions>
    <button mat-button mat-dialog-close>No Thanks</button>
    <button mat-button [mat-dialog-close]="true">Ok</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #subsidyLimitContent>
  <div class="subsidy-limit-container p-3">
    @if (subsidyLimitStatus$ | async; as status) {
      <!-- 期間資訊卡片 -->
      <div class="period-info mb-4">
        <h5 class="text-center mb-2">Subsidy Period (Anniversary)</h5>
        <div class="text-center text-muted">
          {{ status.period.periodStart | date: 'yyyy/MM/dd' }} -
          {{ status.period.periodEnd | date: 'yyyy/MM/dd' }}
        </div>
        <div class="text-center mt-2">
          <mat-chip-set>
            <mat-chip [highlighted]="status.probationPassed">
              {{ status.probationPassed ? '✓' : '✗' }} Probation
            </mat-chip>
            <mat-chip [highlighted]="status.oneYearCompleted">
              {{ status.oneYearCompleted ? '✓' : '✗' }} 1 Year
            </mat-chip>
            <mat-chip>Tenure: {{ status.yearsOfService | number: '1.1-1' }} yrs</mat-chip>
          </mat-chip-set>
        </div>
      </div>

      <!-- 補助額度列表 -->
      <div class="subsidies-list">
        @for (subsidy of status.subsidies; track subsidy.type) {
          <div class="subsidy-card mat-elevation-z2 mb-3 p-3">
            <!-- 標題與資格狀態 -->
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">
                {{ subsidy.displayName }}
                @if (!subsidy.eligible) {
                  <mat-chip class="ms-2" color="warn">{{ subsidy.ineligibleReason }}</mat-chip>
                }
              </h6>
              <span class="badge"
                    [class.bg-success]="subsidy.eligible"
                    [class.bg-secondary]="!subsidy.eligible">
                {{ subsidy.eligible ? 'Eligible' : 'Ineligible' }}
              </span>
            </div>

            <!-- 備註說明（進修+AI限制） -->
            @if (subsidy.note) {
              <div class="text-muted small mb-2">
                <mat-icon class="small-icon">info</mat-icon>
                {{ subsidy.note }}
              </div>
            }

            <!-- 額度資訊 -->
            @if (subsidy.laptopInstallmentInfo) {
              <!-- 筆電補助：顯示領取進度 -->
              <div class="laptop-info mb-2">
                <div class="d-flex justify-content-between text-sm mb-1">
                  <span>Received: {{ subsidy.usedAmount | number: '1.0-0' }}</span>
                  <span>Approved: {{ subsidy.laptopInstallmentInfo.approvedAmount | number: '1.0-0' }}</span>
                </div>
                <div class="text-muted small">
                  Progress: {{ subsidy.laptopInstallmentInfo.receivedCount }}/36 installments
                </div>
              </div>

              <!-- 筆電補助進度條 -->
              <mat-progress-bar
                mode="determinate"
                [value]="getProgressPercentage(subsidy.laptopInstallmentInfo.receivedCount, 36)"
                [color]="getProgressColor(getProgressPercentage(subsidy.laptopInstallmentInfo.receivedCount, 36))"
              ></mat-progress-bar>

              <!-- 領取率 -->
              <div class="text-end text-muted small mt-1">
                Completion: {{ getProgressPercentage(subsidy.laptopInstallmentInfo.receivedCount, 36) | number: '1.0-0' }}%
              </div>
            } @else if (subsidy.type === 1) {
              <!-- 筆電補助：沒有正在領取的申請 -->
              <div class="text-muted small">
                No ongoing laptop subsidy
              </div>
            } @else {
              <!-- 其他補助：顯示一般額度資訊 -->
              <div class="amount-info mb-2">
                <div class="d-flex justify-content-between text-sm">
                  <span>Used: {{ subsidy.usedAmount | number: '1.0-0' }}</span>
                  <span>Available: {{ subsidy.availableAmount | number: '1.0-0' }}</span>
                  <span>Total: {{ subsidy.totalLimit | number: '1.0-0' }}</span>
                </div>
              </div>

              <!-- 進度條 -->
              <mat-progress-bar
                mode="determinate"
                [value]="getProgressPercentage(subsidy.usedAmount, subsidy.totalLimit)"
                [color]="getProgressColor(getProgressPercentage(subsidy.usedAmount, subsidy.totalLimit))"
              ></mat-progress-bar>

              <!-- 使用率 -->
              <div class="text-end text-muted small mt-1">
                Usage: {{ getProgressPercentage(subsidy.usedAmount, subsidy.totalLimit) | number: '1.0-0' }}%
              </div>
            }
          </div>
        }
      </div>
    } @else {
      <div class="text-center text-muted p-4">
        <mat-icon>info</mat-icon>
        <p>Start date not set. Cannot calculate subsidy limits.</p>
      </div>
    }
  </div>
</ng-template>
